<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>작품 업로드 페이지</title>
    <link rel="stylesheet" type="text/css" href="upload.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!--Check logged in-->
    <script>
        let jwtToken = localStorage.getItem('token'); // Check if user is logged in
        if (!jwtToken) {
            window.location.href = "../../index.html" // If user is not logged in, redirect to index.html
        }
    </script>
</head>
<body>

<header class="Container">
    <!--상단 기본 메뉴 영역-->
    <div class="Container-MenuBar">
        <div class="Container-LeftMenu">
            <span class="BrandName"><span>아트브릿지</span></span>
            <a href="../index.html">
                <img alt="Logo image" src="images/header/Logo.png" class="ImgLogo" draggable="false"/>
            </a>
            <span class="HomeMenu"><a href="../index.html">홈</a></span>
            <span class="ArtworkMenu"><a href="../domain/artwork/list.html">작품</a></span>
            <span class="ExhibitionMenu"><a href="../domain/exhibition/list.html">전시회</a></span>
            <span class="IntroduceMenu"><span>소개</span></span>
            <span class="ArtistMenu"><a href="../domain/artist/list.html">아티스트</a></span>
        </div>
        <div class="Container-RightMenu">
            <div class="GroupLoginLogout">
                <span class="TextLogin"><a href="../domain/member/login.html" id="login">LOGIN</a></span>
                <span class="TextDelimeter">ㅣ</span>
                <span class="TextLogout"><a href="../domain/member/logout.html" id="logout">LOGOUT</a></span>
            </div>
            <div class="GroupLanguageSelection">
                <span class="CurrentLanguage"><span>한국어</span></span>
                <img alt="LanguageSelect image" src="images/header/icon_LanguageSelect.png" class="LanguageSelectImgBtn" draggable="false"/>
            </div>
            <div class="BtnUploadArtwork">
                <span class="BtnTextUploadArtwork"><a href="../domain/artwork/upload.html">작품 올리기</a></span>
            </div>
            <div class="BtnUploadExhibition">
                <span class="BtnTextUploadExhibition"><a href="../domain/exhibition/upload.html">전시회 올리기</a></span>
            </div>
            <div class="Container-SearchBar">
                <div class="GroupSearchInputAndButton">
                    <input id="input" placeholder="Search" class="TextSearchInput"/>
                    <a id="searchButton" href="#">
                        <img alt="Search Button image" src="images/header/icon_Search.svg" class="BtnSearch" draggable="false"/>
                    </a>
                </div>
            </div>
        </div>
    </div>
</header>

<div class="artwork-info">
    <h1>작품정보를 작성해주세요</h1>
    <form class="form">
        <p class="recommended-size">권장 사이즈 400X250</p>
        <div class="input-group">
            <input type="text" class="input input-upload" placeholder="이미지 첨부" disabled>
            <input type="file" class="btn upload" id="fileUpload" required>
            <label for="fileUpload" class="fileUpload">파일 선택</label>
        </div>
        <input type="text" class="input" name="artworkName" placeholder="작품 명을 입력해주세요" required>
        <textarea class="input input-large" name="artworkDescription" placeholder="작품 소개를 입력해주세요 (글자수 100자 제한)" required maxlength="100"></textarea>
        <input type="text" class="input" name="makingday" placeholder="작품 제작 연도를 입력해 주세요" required>
        <input type="text" class="input" name="artworkAuthor" placeholder="작가를 입력해주세요" required>
        <textarea class="input input-large" name="artworkLongDescription" placeholder="작품 설명을 해주세요" required></textarea>
        <div class="button-group">
            <button type="submit" class="btn btn-small" id="submitBtn">등록</button>
            <button type="reset" class="btn btn-small">취소</button>
        </div>
    </form>
</div>

<div id="loading" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
    <img src="images/loading.gif" alt="">  <!-- Replace with your loading gif -->
</div>

<!--파일 선택 시 파일명 텍스트 필드에 표시-->
<script>
    document.getElementById("fileUpload").onchange = function() {
        document.querySelector(".input-upload").value = this.files[0].name;
    };
</script>

<!--등록 버튼 클릭 시-->
<script>
    $(document).ready(function () {
        // 폼 제출 이벤트 핸들러 등록
        $(".form").on('submit', function (event) {
            event.preventDefault(); // 일반적인 폼 제출 방지

            disableSubmitButton(); // 제출 버튼 비활성화
            showLoadingIndicator(); // 로딩 표시기 표시

            let formData = buildFormData(); // 폼 데이터 구성
            let jwtToken = getJwtToken(); // JWT 토큰 가져오기

            uploadArtwork(formData, jwtToken); // 작품 업로드
        });
    });

    // 제출 버튼 비활성화
    function disableSubmitButton() {
        $("#submitBtn").prop("disabled", true);
    }

    // 로딩 표시기 표시
    function showLoadingIndicator() {
        $("#loading").show();
    }

    // 폼 데이터 구성
    function buildFormData() {
        let formData = new FormData($(".form")[0]);
        let artworkDTO = {
            title: $("input[name='artworkName']").val(),
            shortDescription: $("textarea[name='artworkDescription']").val(),
            longDescription: $("textarea[name='artworkLongDescription']").val(),
            artistname: $("textarea[name='artworkAuthor']").val(),
            makingday: $("textarea[name='makingday']").val(),
        };
        formData.append('artworkDTO', JSON.stringify(artworkDTO));
        formData.append('image', $('#fileUpload')[0].files[0]);
        return formData;
    }
    // JWT 토큰 가져오기
    function getJwtToken() {
        return localStorage.getItem('token');
    }

    // 작품 업로드
    function uploadArtwork(formData, jwtToken) {
        $.ajax({
            url: 'http://tobiasdev.ml/services/artwork/api/artworks',
            type: 'POST',
            headers: {
                'Authorization': 'Bearer ' + jwtToken
            },
            data: formData,
            cache: false,
            contentType: false,
            processData: false,
            xhrFields: {
                withCredentials: true
            },
            success: function (data, textStatus, xhr) {
                if (xhr.status === 201) {
                    console.log("Artwork successfully uploaded.");
                    console.log(xhr.responseText);
                    enableSubmitButton(); // 제출 버튼 활성화
                    hideLoadingIndicator(); // 로딩 표시기 숨김
                    alert(`작품 업로드 요청 완료되었습니다.`);
                    window.location.href = '../../index.html'; // 성공적으로 로그인한 후 이동할 페이지
                }
            },
            error: function (xhr, textStatus, error) {
                console.error("Upload error: " + xhr.status + " " + xhr.statusText);
                alert(`작품 업로드 요청이 실패하였습니다. 다시 시도해주세요.`);
                enableSubmitButton(); // 제출 버튼 활성화
                hideLoadingIndicator(); // 로딩 표시기 숨김
            }
        });

    }


    // 제출 버튼 활성화
    function enableSubmitButton() {
        $("#submitBtn").prop("disabled", false);
    }

    // 로딩 표시기 숨김
    function hideLoadingIndicator() {
        $("#loading").hide();
    }
</script>


</body>
</html>

